name: Build Firmware

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      # Formatting Check
      - name: Check Formatting (treefmt)
        run: nix develop --command treefmt --fail-on-change

      # Unit Tests
      - name: Run Unit Tests (run-tests)
        run: nix develop --command run-tests

  build:
    needs: check
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          # extra_nix_config: |
          #   sandbox = false

      - name: AppArmor Fix for Bubblewrap
        run: |
          # Allow any bwrap binary in the Nix store to use user namespaces
          cat <<EOF | sudo tee /etc/apparmor.d/bwrap-nix
          abi <abi/4.0>,
          include <tunables/global>

          profile bwrap-nix /nix/store/*/bin/bwrap flags=(unconfined) {
            userns,
            include if exists <local/bwrap>
          }
          EOF

          sudo systemctl reload apparmor
          echo "AppArmor reloaded."

      - name: Build Firmware
        run: nix build

      - name: Prepare Artifacts
        run: |
          mkdir -p artifacts
          # Copy build artifacts from result symlink
          cp result/*.bin artifacts/nimrs-firmware.bin 2>/dev/null || cp result/NIMRS-Firmware.ino.bin artifacts/nimrs-firmware.bin
          cp result/*.elf artifacts/nimrs-firmware.elf 2>/dev/null || cp result/NIMRS-Firmware.ino.elf artifacts/nimrs-firmware.elf
          cp result/partitions.bin artifacts/partitions.bin 2>/dev/null || cp result/NIMRS-Firmware.ino.partitions.bin artifacts/partitions.bin
          cp result/bootloader.bin artifacts/bootloader.bin 2>/dev/null || cp result/NIMRS-Firmware.ino.bootloader.bin artifacts/bootloader.bin
          cp partitions.csv artifacts/partitions.csv

      - name: Upload Nightly Artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: nimrs-firmware-nightly
          path: artifacts/

      - name: Update Nightly Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          name: Nightly Build
          tag_name: nightly
          body: "Rolling release of the latest main branch.\n\nCommit: ${{ github.sha }}"
          files: |
            artifacts/nimrs-firmware.bin
            artifacts/nimrs-firmware.elf
            artifacts/partitions.bin
            artifacts/bootloader.bin
            artifacts/partitions.csv
          prerelease: true

      - name: Release Tag
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/nimrs-firmware.bin
            artifacts/nimrs-firmware.elf
            artifacts/partitions.bin
            artifacts/bootloader.bin
            artifacts/partitions.csv
